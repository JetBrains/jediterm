name: Release Build

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (or none to use current)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major
  push:
    tags:
      - 'v*.*.*'

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true'

jobs:
  prepare-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      base_version: ${{ steps.version.outputs.base_version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump Version (if requested)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        run: |
          BASE_VERSION=$(cat VERSION)
          IFS='.' read -r MAJOR MINOR <<< "$BASE_VERSION"

          case "${{ github.event.inputs.version_bump }}" in
            "patch")
              # Patch is auto-incremented by build number, no change needed
              echo "Patch version is auto-managed by build number"
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              echo "$MAJOR.$MINOR" > VERSION
              ;;
            "major")
              MAJOR=$((MAJOR + 1))
              echo "$MAJOR.0" > VERSION
              ;;
          esac

          echo "VERSION file: $(cat VERSION)"

      - name: Commit Version Bump
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none' && github.event.inputs.version_bump != 'patch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if ! git diff --quiet VERSION; then
            git add VERSION
            git commit -m "Bump version to $(cat VERSION)"
            git push
          fi

      - name: Calculate Version
        id: version
        run: |
          BASE_VERSION=$(cat VERSION)

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag-triggered: extract version from tag
            TAG_VERSION="${{ github.ref }}"
            TAG_VERSION="${TAG_VERSION#refs/tags/v}"
            echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
            echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          else
            # Manual trigger: use VERSION + run_number
            FULL_VERSION="$BASE_VERSION.${{ github.run_number }}"
            echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
            echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          fi

          echo "Computed version: $(cat $GITHUB_OUTPUT | grep version)"

  build-macos:
    needs: prepare-version
    runs-on: macos-latest
    environment: release

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Setup macOS Code Signing
        run: |
          if [[ -n "${{ secrets.MACOS_P12_CERTIFICATE }}" ]]; then
            echo "Setting up macOS code signing..."
            echo "${{ secrets.MACOS_P12_CERTIFICATE }}" | base64 --decode > certificate.p12

            security create-keychain -p temp_password build_keychain
            security default-keychain -s build_keychain
            security unlock-keychain -p temp_password build_keychain
            security set-keychain-settings -lut 3600 build_keychain
            security import certificate.p12 -k build_keychain -P "${{ secrets.MACOS_P12_PASSWORD }}" -T /usr/bin/codesign -T /usr/bin/security
            security set-key-partition-list -S apple-tool:,apple: -s -k temp_password build_keychain
            security list-keychains -s build_keychain

            rm certificate.p12

            echo "MACOS_DEVELOPER_ID=${{ secrets.MACOS_DEVELOPER_ID }}" >> $GITHUB_ENV
            echo "DISABLE_MACOS_SIGNING=false" >> $GITHUB_ENV
          else
            echo "No P12 certificate found, creating unsigned build"
            echo "DISABLE_MACOS_SIGNING=true" >> $GITHUB_ENV
          fi

      - name: Build macOS DMG
        run: |
          chmod +x ./gradlew
          ./gradlew :compose-ui:packageDmg
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Notarize macOS DMG
        if: env.DISABLE_MACOS_SIGNING != 'true'
        run: |
          DMG_PATH=$(find .gradleBuild/compose-ui/compose/binaries/main/dmg -name "*.dmg" | head -1)

          if [[ -n "$DMG_PATH" && -f "$DMG_PATH" ]]; then
            echo "Notarizing: $DMG_PATH"

            # Submit and capture the submission ID
            SUBMIT_OUTPUT=$(xcrun notarytool submit "$DMG_PATH" \
              --apple-id "${{ secrets.MACOS_APPLE_ID }}" \
              --team-id "${{ secrets.MACOS_TEAM_ID }}" \
              --password "${{ secrets.MACOS_APP_PASSWORD }}" \
              --wait 2>&1) || true

            echo "$SUBMIT_OUTPUT"

            # Extract submission ID
            SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | grep -oE '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' | head -1)

            # Check if notarization succeeded or failed
            if echo "$SUBMIT_OUTPUT" | grep -q "status: Invalid"; then
              echo "❌ Notarization failed! Fetching detailed log..."
              xcrun notarytool log "$SUBMISSION_ID" \
                --apple-id "${{ secrets.MACOS_APPLE_ID }}" \
                --team-id "${{ secrets.MACOS_TEAM_ID }}" \
                --password "${{ secrets.MACOS_APP_PASSWORD }}"
              exit 1
            elif echo "$SUBMIT_OUTPUT" | grep -q "status: Accepted"; then
              echo "✅ Notarization succeeded! Stapling..."
              xcrun stapler staple "$DMG_PATH"
            else
              echo "⚠️ Unknown notarization status"
              # Try to get log anyway
              if [[ -n "$SUBMISSION_ID" ]]; then
                xcrun notarytool log "$SUBMISSION_ID" \
                  --apple-id "${{ secrets.MACOS_APPLE_ID }}" \
                  --team-id "${{ secrets.MACOS_TEAM_ID }}" \
                  --password "${{ secrets.MACOS_APP_PASSWORD }}" || true
              fi
              exit 1
            fi
          fi

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-macos-${{ needs.prepare-version.outputs.version }}
          path: .gradleBuild/compose-ui/compose/binaries/main/dmg/*.dmg
          retention-days: 30

  create-release:
    needs: [prepare-version, build-macos]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare Release Assets
        run: |
          mkdir -p ./release-assets
          VERSION="${{ needs.prepare-version.outputs.version }}"
          find ./artifacts -name "*.dmg" -exec cp {} ./release-assets/BossTerm-${VERSION}.dmg \;
          echo "Release assets:"
          ls -la ./release-assets/

      - name: Create Git Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare-version.outputs.version }}
          name: BossTerm v${{ needs.prepare-version.outputs.version }}
          body: |
            ## BossTerm v${{ needs.prepare-version.outputs.version }}

            ### Downloads
            - **macOS**: `BossTerm-${{ needs.prepare-version.outputs.version }}.dmg` (Apple Silicon & Intel)

            ### Installation

            **Via Homebrew (recommended):**
            ```bash
            brew tap kshivang/bossterm
            brew install --cask bossterm
            ```

            **Manual:**
            1. Download the DMG file
            2. Open it and drag BossTerm to Applications
            3. Launch from Applications folder

            ### System Requirements
            - macOS 11.0+ (Big Sur or later)
            - Apple Silicon or Intel processor
          files: ./release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: [prepare-version, create-release]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Homebrew Tap
        uses: actions/checkout@v5
        with:
          repository: kshivang/homebrew-bossterm
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download DMG for SHA256
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          curl -sL "https://github.com/kshivang/BossTerm/releases/download/v${VERSION}/BossTerm-${VERSION}.dmg" -o BossTerm.dmg
          SHA256=$(shasum -a 256 BossTerm.dmg | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Update Cask Formula
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          cat > homebrew-tap/Casks/bossterm.rb << EOF
          cask "bossterm" do
            version "$VERSION"
            sha256 "$SHA256"

            url "https://github.com/kshivang/BossTerm/releases/download/v#{version}/BossTerm-#{version}.dmg",
                verified: "github.com/kshivang/BossTerm/"
            name "BossTerm"
            desc "Modern terminal emulator built with Kotlin/Compose Desktop"
            homepage "https://github.com/kshivang/BossTerm"

            livecheck do
              url :url
              strategy :github_latest
            end

            auto_updates true
            depends_on macos: ">= :big_sur"

            app "BossTerm.app"

            zap trash: [
              "~/Library/Application Support/BossTerm",
              "~/Library/Caches/ai.rever.bossterm",
              "~/Library/Preferences/ai.rever.bossterm.plist",
              "~/Library/Saved Application State/ai.rever.bossterm.savedState",
              "~/.bossterm",
            ]
          end
          EOF

      - name: Commit and Push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/bossterm.rb
          git commit -m "Update BossTerm to ${{ needs.prepare-version.outputs.version }}"
          git push

  publish-libraries:
    needs: [prepare-version, create-release]
    runs-on: macos-latest
    environment: release

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Publish to GitHub Packages
        run: |
          chmod +x ./gradlew
          ./gradlew publishAllPublicationsToGitHubPackagesRepository --no-configuration-cache
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSPHRASE }}

      - name: Publish to Maven Central
        run: |
          ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSPHRASE }}
