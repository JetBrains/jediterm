name: Release Build

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (or none to use current)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major
  push:
    tags:
      - 'v*.*.*'

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true'

jobs:
  prepare-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      base_version: ${{ steps.version.outputs.base_version }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump Version (if requested)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none'
        run: |
          BASE_VERSION=$(cat VERSION)
          IFS='.' read -r MAJOR MINOR <<< "$BASE_VERSION"

          case "${{ github.event.inputs.version_bump }}" in
            "patch")
              # Patch is auto-incremented by build number, no change needed
              echo "Patch version is auto-managed by build number"
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              echo "$MAJOR.$MINOR" > VERSION
              ;;
            "major")
              MAJOR=$((MAJOR + 1))
              echo "$MAJOR.0" > VERSION
              ;;
          esac

          echo "VERSION file: $(cat VERSION)"

      - name: Commit Version Bump
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.version_bump != 'none' && github.event.inputs.version_bump != 'patch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if ! git diff --quiet VERSION; then
            git add VERSION
            git commit -m "Bump version to $(cat VERSION)"
            git push
          fi

      - name: Calculate Version
        id: version
        run: |
          BASE_VERSION=$(cat VERSION)

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag-triggered: extract version from tag
            TAG_VERSION="${{ github.ref }}"
            TAG_VERSION="${TAG_VERSION#refs/tags/v}"
            echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
            echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          else
            # Manual trigger: use VERSION + run_number
            FULL_VERSION="$BASE_VERSION.${{ github.run_number }}"
            echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
            echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          fi

          echo "Computed version: $(cat $GITHUB_OUTPUT | grep version)"

  build-macos:
    needs: prepare-version
    runs-on: macos-latest
    environment: release

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Setup macOS Code Signing
        run: |
          if [[ -n "${{ secrets.MACOS_P12_CERTIFICATE }}" ]]; then
            echo "Setting up macOS code signing..."
            echo "${{ secrets.MACOS_P12_CERTIFICATE }}" | base64 --decode > certificate.p12

            security create-keychain -p temp_password build_keychain
            security default-keychain -s build_keychain
            security unlock-keychain -p temp_password build_keychain
            security set-keychain-settings -lut 3600 build_keychain
            security import certificate.p12 -k build_keychain -P "${{ secrets.MACOS_P12_PASSWORD }}" -T /usr/bin/codesign -T /usr/bin/security
            security set-key-partition-list -S apple-tool:,apple: -s -k temp_password build_keychain
            security list-keychains -s build_keychain

            rm certificate.p12

            echo "MACOS_DEVELOPER_ID=${{ secrets.MACOS_DEVELOPER_ID }}" >> $GITHUB_ENV
            echo "DISABLE_MACOS_SIGNING=false" >> $GITHUB_ENV
          else
            echo "No P12 certificate found, creating unsigned build"
            echo "DISABLE_MACOS_SIGNING=true" >> $GITHUB_ENV
          fi

      - name: Build macOS App Bundle
        run: |
          chmod +x ./gradlew
          ./gradlew :compose-ui:createDistributable
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Sign Native Executables in JARs
        if: env.DISABLE_MACOS_SIGNING != 'true'
        run: |
          # Convert to absolute path to avoid issues when changing directories
          APP_PATH=$(find "$(pwd)/.gradleBuild/compose-ui/compose/binaries/main/app" -name "*.app" -type d | head -1)
          echo "App bundle: $APP_PATH"

          if [[ -n "$APP_PATH" && -d "$APP_PATH" ]]; then
            # Find all JARs that might contain native executables
            find "$APP_PATH/Contents/app" -name "*.jar" | while read JAR_PATH; do
              # Convert JAR_PATH to absolute path
              JAR_PATH=$(cd "$(dirname "$JAR_PATH")" && pwd)/$(basename "$JAR_PATH")

              # Check if JAR contains native darwin executables
              if unzip -l "$JAR_PATH" 2>/dev/null | grep -q "darwin"; then
                echo "Processing: $JAR_PATH"

                # Create temp directory
                TEMP_DIR=$(mktemp -d)
                JAR_NAME=$(basename "$JAR_PATH")

                # Extract JAR
                unzip -q "$JAR_PATH" -d "$TEMP_DIR"

                # Find and sign native executables (not just dylibs)
                SIGNED_COUNT=0
                while IFS= read -r -d '' NATIVE_FILE; do
                  # Check if it's a Mach-O executable or dylib
                  if file "$NATIVE_FILE" | grep -q "Mach-O"; then
                    echo "  Signing: $NATIVE_FILE"
                    codesign --force --options runtime --timestamp \
                      --sign "${{ secrets.MACOS_DEVELOPER_ID }}" \
                      --entitlements compose-ui/src/desktopMain/resources/runtime-entitlements.plist \
                      "$NATIVE_FILE" || echo "  Warning: Failed to sign $NATIVE_FILE"
                    SIGNED_COUNT=$((SIGNED_COUNT + 1))
                  fi
                done < <(find "$TEMP_DIR" -type f \( -name "*darwin*" -o -path "*/native/*" \) -print0)

                # Repackage JAR if we signed anything or found darwin files
                if [[ "$SIGNED_COUNT" -gt 0 ]] || find "$TEMP_DIR" -name "*darwin*" | grep -q .; then
                  echo "  Repackaging: $JAR_NAME (signed $SIGNED_COUNT files)"
                  rm "$JAR_PATH"
                  (cd "$TEMP_DIR" && zip -qr "$JAR_PATH" .)
                fi

                rm -rf "$TEMP_DIR"
              fi
            done

            # Re-sign the entire app bundle after modifying JARs
            echo "Re-signing app bundle..."
            codesign --force --deep --options runtime --timestamp \
              --sign "${{ secrets.MACOS_DEVELOPER_ID }}" \
              --entitlements compose-ui/src/desktopMain/resources/entitlements.plist \
              "$APP_PATH"
          fi

      - name: Package macOS DMG
        run: |
          ./gradlew :compose-ui:packageDmg
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Notarize macOS DMG
        if: env.DISABLE_MACOS_SIGNING != 'true'
        run: |
          DMG_PATH=$(find .gradleBuild/compose-ui/compose/binaries/main/dmg -name "*.dmg" | head -1)

          if [[ -n "$DMG_PATH" && -f "$DMG_PATH" ]]; then
            echo "Notarizing: $DMG_PATH"

            # Submit and capture the submission ID
            SUBMIT_OUTPUT=$(xcrun notarytool submit "$DMG_PATH" \
              --apple-id "${{ secrets.MACOS_APPLE_ID }}" \
              --team-id "${{ secrets.MACOS_TEAM_ID }}" \
              --password "${{ secrets.MACOS_APP_PASSWORD }}" \
              --wait 2>&1) || true

            echo "$SUBMIT_OUTPUT"

            # Extract submission ID
            SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | grep -oE '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' | head -1)

            # Check if notarization succeeded or failed
            if echo "$SUBMIT_OUTPUT" | grep -q "status: Invalid"; then
              echo "❌ Notarization failed! Fetching detailed log..."
              xcrun notarytool log "$SUBMISSION_ID" \
                --apple-id "${{ secrets.MACOS_APPLE_ID }}" \
                --team-id "${{ secrets.MACOS_TEAM_ID }}" \
                --password "${{ secrets.MACOS_APP_PASSWORD }}"
              exit 1
            elif echo "$SUBMIT_OUTPUT" | grep -q "status: Accepted"; then
              echo "✅ Notarization succeeded! Stapling..."
              xcrun stapler staple "$DMG_PATH"
            else
              echo "⚠️ Unknown notarization status"
              # Try to get log anyway
              if [[ -n "$SUBMISSION_ID" ]]; then
                xcrun notarytool log "$SUBMISSION_ID" \
                  --apple-id "${{ secrets.MACOS_APPLE_ID }}" \
                  --team-id "${{ secrets.MACOS_TEAM_ID }}" \
                  --password "${{ secrets.MACOS_APP_PASSWORD }}" || true
              fi
              exit 1
            fi
          fi

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-macos-${{ needs.prepare-version.outputs.version }}
          path: .gradleBuild/compose-ui/compose/binaries/main/dmg/*.dmg
          retention-days: 30

  build-linux-amd64:
    needs: prepare-version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Install RPM Tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Generate Linux Icons
        run: |
          pip install pillow
          python3 create_icon.py || echo "Icon generation requires fonts, using placeholder"
          # Create placeholder icons if generation fails
          if [ ! -f "BossTerm.png" ]; then
            convert -size 256x256 xc:black -fill green -gravity center -pointsize 72 -annotate 0 "BOSS" BossTerm.png || \
            echo "Using existing icon or creating minimal placeholder"
          fi
          mkdir -p snap/gui
          if [ ! -f "snap/gui/bossterm.png" ]; then
            cp BossTerm.png snap/gui/bossterm.png 2>/dev/null || true
          fi

      - name: Build Linux Packages (Deb & RPM)
        run: |
          chmod +x ./gradlew
          ./gradlew :compose-ui:packageDeb :compose-ui:packageRpm
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Build Uber JAR
        run: |
          ./gradlew :compose-ui:packageUberJarForCurrentOS
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Upload Deb Package
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-linux-amd64-deb-${{ needs.prepare-version.outputs.version }}
          path: .gradleBuild/compose-ui/compose/binaries/main/deb/*.deb
          retention-days: 30

      - name: Upload RPM Package
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-linux-amd64-rpm-${{ needs.prepare-version.outputs.version }}
          path: .gradleBuild/compose-ui/compose/binaries/main/rpm/*.rpm
          retention-days: 30

      - name: Upload Uber JAR
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-jar-${{ needs.prepare-version.outputs.version }}
          path: .gradleBuild/compose-ui/compose/jars/*.jar
          retention-days: 30

  build-linux-arm64:
    needs: prepare-version
    runs-on: ubuntu-24.04-arm
    # ARM64 runners may not be available in all GitHub plans
    # This job will be skipped if the runner is not available
    continue-on-error: true

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Install RPM Tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Generate Linux Icons
        run: |
          pip install pillow
          python3 create_icon.py || echo "Icon generation requires fonts, using placeholder"
          if [ ! -f "BossTerm.png" ]; then
            convert -size 256x256 xc:black -fill green -gravity center -pointsize 72 -annotate 0 "BOSS" BossTerm.png || true
          fi
          mkdir -p snap/gui
          if [ ! -f "snap/gui/bossterm.png" ]; then
            cp BossTerm.png snap/gui/bossterm.png 2>/dev/null || true
          fi

      - name: Build Linux Packages (Deb & RPM)
        run: |
          chmod +x ./gradlew
          ./gradlew :compose-ui:packageDeb :compose-ui:packageRpm
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}

      - name: Upload Deb Package (ARM64)
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-linux-arm64-deb-${{ needs.prepare-version.outputs.version }}
          path: .gradleBuild/compose-ui/compose/binaries/main/deb/*.deb
          retention-days: 30

      - name: Upload RPM Package (ARM64)
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-linux-arm64-rpm-${{ needs.prepare-version.outputs.version }}
          path: .gradleBuild/compose-ui/compose/binaries/main/rpm/*.rpm
          retention-days: 30

  build-snap:
    needs: prepare-version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Generate Snap Icon
        run: |
          pip install pillow
          python3 create_icon.py || echo "Icon generation failed, continuing..."
          mkdir -p snap/gui
          if [ ! -f "snap/gui/bossterm.png" ]; then
            # Create a simple placeholder
            convert -size 512x512 xc:black -fill green -gravity center -pointsize 144 -annotate 0 "BOSS" snap/gui/bossterm.png || true
          fi

      - name: Build Snap
        uses: snapcore/action-build@v1
        id: snapcraft

      - name: Upload Snap
        uses: actions/upload-artifact@v4
        with:
          name: bossterm-snap-${{ needs.prepare-version.outputs.version }}
          path: ${{ steps.snapcraft.outputs.snap }}
          retention-days: 30

      # Optional: Publish to Snap Store (requires SNAPCRAFT_STORE_CREDENTIALS secret)
      # To get credentials: snapcraft export-login --snaps=bossterm --acls package_access,package_push,package_update,package_release credentials.txt
      - name: Publish to Snap Store
        if: env.SNAPCRAFT_STORE_CREDENTIALS != ''
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
        with:
          snap: ${{ steps.snapcraft.outputs.snap }}
          release: edge

  create-release:
    needs: [prepare-version, build-macos, build-linux-amd64, build-linux-arm64, build-snap]
    # Continue even if ARM64 build fails (may not be available)
    if: always() && needs.build-macos.result == 'success' && needs.build-linux-amd64.result == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare Release Assets
        run: |
          mkdir -p ./release-assets
          VERSION="${{ needs.prepare-version.outputs.version }}"

          # macOS
          find ./artifacts -name "*.dmg" -exec cp {} ./release-assets/BossTerm-${VERSION}-macos.dmg \;

          # Linux AMD64
          find ./artifacts -name "*.deb" -path "*amd64*" -exec cp {} ./release-assets/bossterm_${VERSION}_amd64.deb \;
          find ./artifacts -name "*.rpm" -path "*amd64*" -exec cp {} ./release-assets/bossterm-${VERSION}.x86_64.rpm \;

          # Linux ARM64 (if available)
          find ./artifacts -name "*.deb" -path "*arm64*" -exec cp {} ./release-assets/bossterm_${VERSION}_arm64.deb \; 2>/dev/null || true
          find ./artifacts -name "*.rpm" -path "*arm64*" -exec cp {} ./release-assets/bossterm-${VERSION}.aarch64.rpm \; 2>/dev/null || true

          # Snap (if available)
          find ./artifacts -name "*.snap" -exec cp {} ./release-assets/bossterm_${VERSION}_amd64.snap \; 2>/dev/null || true

          # Uber JAR
          find ./artifacts -name "*.jar" -exec cp {} ./release-assets/bossterm-${VERSION}.jar \; 2>/dev/null || true

          echo "Release assets:"
          ls -la ./release-assets/

      - name: Create Git Tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare-version.outputs.version }}
          name: BossTerm v${{ needs.prepare-version.outputs.version }}
          body: |
            ## BossTerm v${{ needs.prepare-version.outputs.version }}

            ### Downloads

            | Platform | Architecture | Package |
            |----------|--------------|---------|
            | **macOS** | Universal | `BossTerm-${{ needs.prepare-version.outputs.version }}-macos.dmg` |
            | **Ubuntu/Debian** | AMD64 | `bossterm_${{ needs.prepare-version.outputs.version }}_amd64.deb` |
            | **Ubuntu/Debian** | ARM64 | `bossterm_${{ needs.prepare-version.outputs.version }}_arm64.deb` |
            | **Fedora/RHEL** | AMD64 | `bossterm-${{ needs.prepare-version.outputs.version }}.x86_64.rpm` |
            | **Fedora/RHEL** | ARM64 | `bossterm-${{ needs.prepare-version.outputs.version }}.aarch64.rpm` |
            | **Snap** | AMD64 | `bossterm_${{ needs.prepare-version.outputs.version }}_amd64.snap` |
            | **Any (JAR)** | Any | `bossterm-${{ needs.prepare-version.outputs.version }}.jar` |

            ### Installation

            **macOS (Homebrew):**
            ```bash
            brew tap kshivang/bossterm
            brew install --cask bossterm
            ```

            **Ubuntu/Debian:**
            ```bash
            sudo dpkg -i bossterm_${{ needs.prepare-version.outputs.version }}_amd64.deb
            sudo apt-get install -f  # Install dependencies
            ```

            **Fedora/RHEL:**
            ```bash
            sudo dnf install bossterm-${{ needs.prepare-version.outputs.version }}.x86_64.rpm
            ```

            **Snap:**
            ```bash
            sudo snap install bossterm --classic
            # Or from downloaded file:
            sudo snap install bossterm_*.snap --classic --dangerous
            ```

            **JAR (requires Java 17+):**
            ```bash
            java -jar bossterm-${{ needs.prepare-version.outputs.version }}.jar
            ```

            ### System Requirements
            - **macOS**: 11.0+ (Big Sur or later), Apple Silicon or Intel
            - **Linux**: X11 or Wayland, glibc 2.31+
            - **JAR**: Java 17+ runtime
          files: ./release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: [prepare-version, create-release]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Homebrew Tap
        uses: actions/checkout@v5
        with:
          repository: kshivang/homebrew-bossterm
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Download DMG for SHA256
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          curl -sL "https://github.com/kshivang/BossTerm/releases/download/v${VERSION}/BossTerm-${VERSION}.dmg" -o BossTerm.dmg
          SHA256=$(shasum -a 256 BossTerm.dmg | cut -d' ' -f1)
          echo "SHA256=$SHA256" >> $GITHUB_ENV

      - name: Update Cask Formula
        run: |
          VERSION="${{ needs.prepare-version.outputs.version }}"
          cat > homebrew-tap/Casks/bossterm.rb << EOF
          cask "bossterm" do
            version "$VERSION"
            sha256 "$SHA256"

            url "https://github.com/kshivang/BossTerm/releases/download/v#{version}/BossTerm-#{version}.dmg",
                verified: "github.com/kshivang/BossTerm/"
            name "BossTerm"
            desc "Modern terminal emulator built with Kotlin/Compose Desktop"
            homepage "https://github.com/kshivang/BossTerm"

            livecheck do
              url :url
              strategy :github_latest
            end

            auto_updates true
            depends_on macos: ">= :big_sur"

            app "BossTerm.app"

            zap trash: [
              "~/Library/Application Support/BossTerm",
              "~/Library/Caches/ai.rever.bossterm",
              "~/Library/Preferences/ai.rever.bossterm.plist",
              "~/Library/Saved Application State/ai.rever.bossterm.savedState",
              "~/.bossterm",
            ]
          end
          EOF

      - name: Commit and Push
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/bossterm.rb
          git commit -m "Update BossTerm to ${{ needs.prepare-version.outputs.version }}"
          git push

  publish-libraries:
    needs: [prepare-version, create-release]
    runs-on: macos-latest
    # No environment needed - build-macos already requires 'release' environment approval

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Setup JDK
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Publish to GitHub Packages
        run: |
          chmod +x ./gradlew
          ./gradlew publishAllPublicationsToGitHubPackagesRepository --no-configuration-cache
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSPHRASE }}

      - name: Publish to Maven Central
        run: |
          ./gradlew publishAndReleaseToMavenCentral --no-configuration-cache
        env:
          RELEASE_BUILD: true
          BUILD_NUMBER: ${{ github.run_number }}
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SIGNING_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.GPG_SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SIGNING_PASSPHRASE }}

      - name: Trigger JitPack Build
        run: |
          # Trigger JitPack to index the new version
          curl -s "https://jitpack.io/api/builds/kshivang/BossTerm/v${{ needs.prepare-version.outputs.version }}" || true
          echo "Triggered JitPack build for v${{ needs.prepare-version.outputs.version }}"