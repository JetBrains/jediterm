#!/usr/bin/env bash
#
# BossTerm CLI Launcher Script (Linux)
# Version: 1.0.0
#
# Opens BossTerm terminal emulator with optional arguments
#
# Usage:
#   bossterm                      # Opens BossTerm
#   bossterm -d <path>            # Opens BossTerm in directory
#   bossterm -c <command>         # Opens BossTerm and runs command
#   bossterm <path>               # Smart detect: opens in directory if path exists
#

VERSION="1.0.0"

# Find BossTerm installation
find_bossterm() {
    # Check common installation locations
    local locations=(
        "/opt/bossterm/bin/BossTerm"
        "/usr/local/bin/BossTerm"
        "/usr/bin/BossTerm"
        "$HOME/.local/share/bossterm/bin/BossTerm"
        # Snap location
        "/snap/bossterm/current/bin/bossterm"
        # AppImage in common locations
        "$HOME/Applications/BossTerm*.AppImage"
        "$HOME/.local/bin/BossTerm*.AppImage"
    )

    for loc in "${locations[@]}"; do
        # Handle glob patterns
        for expanded in $loc; do
            if [ -x "$expanded" ]; then
                echo "$expanded"
                return 0
            fi
        done
    done

    # Check if running as Snap
    if [ -n "$SNAP" ]; then
        echo "$SNAP/bin/bossterm"
        return 0
    fi

    return 1
}

APP_PATH=$(find_bossterm)

# Check if app exists
check_app() {
    if [ -z "$APP_PATH" ] || [ ! -x "$APP_PATH" ]; then
        echo "Error: BossTerm not found"
        echo ""
        echo "To install BossTerm:"
        echo ""
        echo "  Via Snap (recommended):"
        echo "    sudo snap install bossterm --classic"
        echo ""
        echo "  Via Deb package:"
        echo "    sudo dpkg -i bossterm_*.deb"
        echo "    sudo apt-get install -f"
        echo ""
        echo "  Via RPM package:"
        echo "    sudo dnf install bossterm_*.rpm"
        echo ""
        exit 1
    fi
}

# Open BossTerm app
open_bossterm() {
    if [ -n "$BOSSTERM_CWD" ]; then
        cd "$BOSSTERM_CWD" || exit 1
    fi

    # Launch in background and detach
    nohup "$APP_PATH" "$@" >/dev/null 2>&1 &
    disown
}

# Expand path (handle ~, ., .., relative paths)
expand_path() {
    local path="$1"
    # Expand tilde
    path="${path/#\~/$HOME}"
    # Handle relative paths
    if [[ ! "$path" =~ ^/ ]]; then
        path="$(cd "$path" 2>/dev/null && pwd || echo "$(pwd)/$path")"
    fi
    echo "$path"
}

# Show help
show_help() {
    cat <<EOF
BossTerm - Modern Terminal Emulator
Version: $VERSION

Usage:
  bossterm                      Open BossTerm
  bossterm <path>               Open BossTerm in directory (if path exists)
  bossterm -d <path>            Open BossTerm in specified directory
  bossterm -c <command>         Open BossTerm and run command (coming soon)
  bossterm --new-window         Open a new BossTerm window

Options:
  -d, --directory <path>   Start in specified directory
  -c, --command <cmd>      Execute command after opening (coming soon)
  -n, --new-window         Force open a new window
  -v, --version            Show version information
  -h, --help               Show this help message

Examples:
  bossterm                      # Open BossTerm
  bossterm ~/Projects           # Open in Projects directory
  bossterm -d /tmp              # Open in /tmp directory
  bossterm .                    # Open in current directory
  bossterm --new-window         # Open new window

Shell Integration:
  Add this to your ~/.bashrc or ~/.zshrc for working directory tracking:

  For Bash:
    PROMPT_COMMAND='echo -ne "\\033]7;file://\${HOSTNAME}\${PWD}\\007"'

  For Zsh:
    precmd() { echo -ne "\\033]7;file://\${HOST}\${PWD}\\007" }

EOF
}

# Show version
show_version() {
    echo "BossTerm CLI version $VERSION"
}

# Main logic
main() {
    check_app

    # No arguments - just open the app
    if [ $# -eq 0 ]; then
        open_bossterm
        exit 0
    fi

    # Parse arguments
    case "$1" in
        -h|--help|help)
            show_help
            exit 0
            ;;

        -v|--version|version)
            show_version
            exit 0
            ;;

        -n|--new-window)
            open_bossterm --new-window
            exit 0
            ;;

        -d|--directory)
            if [ -z "$2" ]; then
                echo "Error: Directory path required"
                echo "Usage: bossterm -d <path>"
                exit 1
            fi
            dir_path=$(expand_path "$2")
            if [ ! -d "$dir_path" ]; then
                echo "Error: Directory not found: $dir_path"
                exit 1
            fi
            # Set working directory via environment variable
            BOSSTERM_CWD="$dir_path" open_bossterm
            exit 0
            ;;

        -c|--command)
            if [ -z "$2" ]; then
                echo "Error: Command required"
                echo "Usage: bossterm -c <command>"
                exit 1
            fi
            echo "Note: Command execution requires app support (coming soon)"
            echo "Opening BossTerm..."
            open_bossterm
            exit 0
            ;;

        -*)
            echo "Error: Unknown option: $1"
            echo "Run 'bossterm --help' for usage information"
            exit 1
            ;;

        *)
            # Smart detection - check if it's a directory
            path=$(expand_path "$1")
            if [ -d "$path" ]; then
                BOSSTERM_CWD="$path" open_bossterm
                exit 0
            elif [ -f "$path" ]; then
                # It's a file - open in parent directory
                parent_dir=$(dirname "$path")
                BOSSTERM_CWD="$parent_dir" open_bossterm
                exit 0
            else
                echo "Error: Path not found: $1"
                echo "Run 'bossterm --help' for usage information"
                exit 1
            fi
            ;;
    esac
}

main "$@"
